name: CI - Pipeline before Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ========== ä»£ç è´¨é‡æ£€æŸ¥ ==========
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    # å¦‚æœå‰é¢çš„æ£€æŸ¥å¤±è´¥ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ£€æŸ¥
    continue-on-error: false
    permissions:
      contents: read  # éœ€è¦æƒé™æ¥è¯»å–ä»£ç 
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # Checkstyle ä»£ç é£æ ¼æ£€æŸ¥ï¼ˆå·²æœ‰é…ç½®æ–‡ä»¶ï¼Œå–æ¶ˆæ³¨é‡Š pom.xml ä¸­çš„æ’ä»¶å³å¯å¯ç”¨ï¼‰
      - name: Run Checkstyle
        run: mvn checkstyle:check
        continue-on-error: true  # æš‚æ—¶å…è®¸å¤±è´¥ï¼Œç­‰é…ç½®å¥½åå†æ”¹ä¸º false

      # SpotBugs é™æ€ä»£ç åˆ†æï¼ˆéœ€è¦å…ˆåœ¨ pom.xml ä¸­æ·»åŠ æ’ä»¶ï¼‰
      # - name: Run SpotBugs
      #   run: mvn spotbugs:check
      #   continue-on-error: true

  # ========== å®‰å…¨æ‰«æ ==========
#  security-scan:
#    name: Security Scan
#    runs-on: ubuntu-latest
#    continue-on-error: true  # å®‰å…¨æ‰«æå¤±è´¥ä¸åº”è¯¥é˜»æ­¢ PR
#    permissions:
#      contents: read  # éœ€è¦æƒé™æ¥è¯»å–ä»£ç 
#      security-events: write  # CodeQL éœ€è¦æƒé™æ¥ä¸Šä¼ å®‰å…¨åˆ†æç»“æœ
#      actions: read  # CodeQL éœ€è¦æƒé™æ¥è¯»å– actions
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 17
#        uses: actions/setup-java@v4
#        with:
#          distribution: temurin
#          java-version: '17'
#
#      - name: Cache Maven local repository
#        uses: actions/cache@v4
#        with:
#          path: ~/.m2/repository
#          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
#          restore-keys: |
#            ${{ runner.os }}-m2-

      # OWASP Dependency-Check - ä¾èµ–æ¼æ´æ‰«æ
      # éœ€è¦å…ˆåœ¨ pom.xml ä¸­æ·»åŠ  org.owasp:dependency-check-maven æ’ä»¶
      # - name: OWASP Dependency Check
      #   run: mvn org.owasp:dependency-check-maven:check
      #   continue-on-error: true

      # GitHub CodeQL - ä»£ç å®‰å…¨åˆ†æï¼ˆGitHub å…è´¹æä¾›ï¼‰
#      - name: Initialize CodeQL
#        uses: github/codeql-action/init@v3
#        with:
#          languages: java
#          queries: security-extended,security-and-quality
#
#      - name: Perform CodeQL Analysis
#        uses: github/codeql-action/analyze@v3
#        continue-on-error: true

  # ========== æ„å»ºå’Œæµ‹è¯• ==========
  build:
    name: Build and Unit Test
    runs-on: ubuntu-latest
    needs: []  # å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œä¸ä¾èµ–å…¶ä»– job
    permissions:
      checks: write      # éœ€è¦æƒé™æ¥åˆ›å»º check runsï¼ˆç”¨äºæµ‹è¯•ç»“æœæŠ¥å‘Šï¼‰
      pull-requests: write  # éœ€è¦æƒé™æ¥åœ¨ PR ä¸Šåˆ›å»ºè¯„è®º
      contents: read      # éœ€è¦æƒé™æ¥è¯»å–ä»£ç 
      statuses: write    # å¯èƒ½éœ€è¦ç”¨äºåˆ›å»ºçŠ¶æ€
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # æ„å»ºé¡¹ç›®ï¼ˆåŒ…å«æµ‹è¯•ï¼‰
      - name: Build with Maven
        run: mvn -B -V -e -T 1C clean verify

      # ä¸Šä¼ æµ‹è¯•ç»“æœåˆ° GitHub Checksï¼ˆå¦‚æœæµ‹è¯•å¤±è´¥ï¼Œä¼šæ˜¾ç¤ºåœ¨ PR ä¸­ï¼‰
      - name: Publish Test Results to Checks
        uses: dorny/test-reporter@v1
        if: always()  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿä¸Šä¼ ç»“æœ
        with:
          name: Unit Test Results
          path: '**/target/surefire-reports/TEST-*.xml'
          reporter: 'java-junit'
          fail-on-error: false  # æµ‹è¯•å¤±è´¥ä¸é˜»æ­¢ workflow
          list-suites: 'all'  # æ˜¾ç¤ºæ‰€æœ‰æµ‹è¯•å¥—ä»¶
          list-tests: 'failed'  # åªåˆ—å‡ºå¤±è´¥çš„æµ‹è¯•
          max-annotations: 50  # æœ€å¤§æ³¨é‡Šæ•°é‡
          # token ä¼šè‡ªåŠ¨ä½¿ç”¨ GITHUB_TOKENï¼Œæ— éœ€æ˜¾å¼ä¼ é€’

      # ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶ä½œä¸º artifactï¼Œä¾› pr-summary job ä½¿ç”¨
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: '**/target/surefire-reports/TEST-*.xml'
          retention-days: 1


      # ä»£ç è¦†ç›–ç‡æŠ¥å‘Šï¼ˆéœ€è¦å…ˆåœ¨ pom.xml ä¸­æ·»åŠ  JaCoCo æ’ä»¶ï¼‰
      # - name: Generate Coverage Report
      #   run: mvn jacoco:report
      #   continue-on-error: true

      # - name: Upload Coverage to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     files: '**/target/site/jacoco/jacoco.xml'
      #     fail_ci_if_error: false


  # ========== ä»£ç æ ¼å¼åŒ–æ£€æŸ¥ ==========
#  format-check:
#    name: Code Format Check
#    runs-on: ubuntu-latest
#    continue-on-error: true
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 17
#        uses: actions/setup-java@v4
#        with:
#          distribution: temurin
#          java-version: '17'

      # æ£€æŸ¥ä»£ç æ˜¯å¦ç¬¦åˆ Google Java Formatï¼ˆéœ€è¦å…ˆé…ç½®æ ¼å¼åŒ–æ’ä»¶ï¼‰
      # - name: Check Code Format
      #   run: mvn com.spotify.fmt:fmt-maven-plugin:check
      #   continue-on-error: true

  # ========== PR æ³¨é‡Šæ€»ç»“ï¼ˆåˆå¹¶ CI æ£€æŸ¥ç»“æœå’Œå•å…ƒæµ‹è¯•ç»“æœï¼‰ ==========
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [build, code-quality]
    if: always()
    permissions:
      issues: write      # éœ€è¦æƒé™æ¥åˆ›å»º/æ›´æ–° issue è¯„è®ºï¼ˆPR ä¹Ÿæ˜¯ issueï¼‰
      pull-requests: write  # éœ€è¦æƒé™æ¥åœ¨ PR ä¸Šæ“ä½œ
      contents: read      # éœ€è¦æƒé™æ¥è¯»å–æ–‡ä»¶
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Test Reports
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-reports
          path: test-reports

      - name: Generate Combined PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // è·å–å„ä¸ª job çš„çŠ¶æ€
            const buildStatus = '${{ needs.build.result }}';
            const qualityStatus = '${{ needs.code-quality.result }}';
            
            // çŠ¶æ€å›¾æ ‡æ˜ å°„
            const getStatusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'cancelled') return 'ğŸš«';
              if (status === 'skipped') return 'â­ï¸';
              return 'â³';
            };
            
            // è§£ææµ‹è¯•ç»“æœ
            let totalTests = 0;
            let totalFailures = 0;
            let totalErrors = 0;
            let totalSkipped = 0;
            let totalTime = 0;
            
            try {
              // é¦–å…ˆå°è¯•ä»ä¸‹è½½çš„ artifact ä¸­è¯»å–
              let reportFiles = [];
              
              // æ–¹æ³•1: ä»ä¸‹è½½çš„ artifact ç›®å½•è¯»å–
              if (fs.existsSync('test-reports')) {
                const walkDir = (dir, fileList = []) => {
                  const files = fs.readdirSync(dir);
                  files.forEach(file => {
                    const filePath = dir + '/' + file;
                    if (fs.statSync(filePath).isDirectory()) {
                      walkDir(filePath, fileList);
                    } else if (file.endsWith('.xml')) {
                      fileList.push(filePath);
                    }
                  });
                  return fileList;
                };
                reportFiles = walkDir('test-reports');
                console.log(`Found ${reportFiles.length} files in test-reports artifact`);
              }
              
              // æ–¹æ³•2: å¦‚æœ artifact ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»å½“å‰ç›®å½•æŸ¥æ‰¾ï¼ˆå¤šæ¨¡å—é¡¹ç›®ï¼‰
              if (reportFiles.length === 0) {
                try {
                  const findResult = execSync('find . -name "TEST-*.xml" -path "*/target/surefire-reports/*" 2>/dev/null', { encoding: 'utf8' });
                  reportFiles = findResult.trim().split('\n').filter(f => f);
                  console.log(`Found ${reportFiles.length} files using find command`);
                } catch (e) {
                  console.log('Find command failed, trying glob pattern');
                  // ä½¿ç”¨ç®€å•çš„é€’å½’æŸ¥æ‰¾
                  const findAllXml = (dir) => {
                    let results = [];
                    const list = fs.readdirSync(dir);
                    list.forEach(file => {
                      const filePath = dir + '/' + file;
                      const stat = fs.statSync(filePath);
                      if (stat && stat.isDirectory()) {
                        results = results.concat(findAllXml(filePath));
                      } else if (file.endsWith('.xml') && file.startsWith('TEST-')) {
                        results.push(filePath);
                      }
                    });
                    return results;
                  };
                  reportFiles = findAllXml('.');
                  console.log(`Found ${reportFiles.length} files using recursive search`);
                }
              }
              
              console.log(`Total report files found: ${reportFiles.length}`);
              
              // è§£ææ¯ä¸ªæŠ¥å‘Šæ–‡ä»¶
              reportFiles.forEach(file => {
                try {
                  if (!fs.existsSync(file)) {
                    console.log(`File not found: ${file}`);
                    return;
                  }
                  const content = fs.readFileSync(file, 'utf8');
                  const testsMatch = content.match(/tests="(\d+)"/);
                  const failuresMatch = content.match(/failures="(\d+)"/);
                  const errorsMatch = content.match(/errors="(\d+)"/);
                  const skippedMatch = content.match(/skipped="(\d+)"/);
                  const timeMatch = content.match(/time="([\d.]+)"/);
                  
                  if (testsMatch) {
                    const tests = parseInt(testsMatch[1]);
                    totalTests += tests;
                    console.log(`File ${file}: ${tests} tests`);
                  }
                  if (failuresMatch) totalFailures += parseInt(failuresMatch[1]);
                  if (errorsMatch) totalErrors += parseInt(errorsMatch[1]);
                  if (skippedMatch) totalSkipped += parseInt(skippedMatch[1]);
                  if (timeMatch) totalTime += parseFloat(timeMatch[1]);
                } catch (error) {
                  console.log(`Error parsing ${file}: ${error.message}`);
                }
              });
              
              console.log(`Final totals - Tests: ${totalTests}, Failures: ${totalFailures}, Errors: ${totalErrors}, Skipped: ${totalSkipped}, Time: ${totalTime.toFixed(2)}s`);
            } catch (error) {
              console.log('Error finding test report files:', error.message);
              console.log(error.stack);
            }
            
            // ç”Ÿæˆåˆå¹¶çš„è¯„è®ºå†…å®¹
            const testStatus = (totalFailures === 0 && totalErrors === 0) ? 'âœ…' : 'âŒ';
            const passed = totalTests - totalFailures - totalErrors - totalSkipped;
            
            const comment = 
              '## ğŸ“Š CI æ£€æŸ¥ç»“æœ\n\n' +
              '### æ£€æŸ¥é¡¹çŠ¶æ€\n' +
              '| æ£€æŸ¥é¡¹ | çŠ¶æ€ |\n' +
              '|--------|------|\n' +
              '| æ„å»ºå’Œæµ‹è¯• | ' + getStatusIcon(buildStatus) + ' ' + buildStatus + ' |\n' +
              '| ä»£ç è´¨é‡ | ' + getStatusIcon(qualityStatus) + ' ' + qualityStatus + ' |\n\n' +
              '### ' + testStatus + ' å•å…ƒæµ‹è¯•ç»“æœ\n' +
              '| æŒ‡æ ‡ | ç»“æœ |\n' +
              '|------|------|\n' +
              '| æ€»æµ‹è¯•æ•° | ' + totalTests + ' |\n' +
              '| é€šè¿‡ | ' + passed + ' âœ… |\n' +
              '| å¤±è´¥ | ' + totalFailures + (totalFailures > 0 ? ' âŒ' : '') + ' |\n' +
              '| é”™è¯¯ | ' + totalErrors + (totalErrors > 0 ? ' âŒ' : '') + ' |\n' +
              '| è·³è¿‡ | ' + totalSkipped + (totalSkipped > 0 ? ' ğŸ’¤' : '') + ' |\n' +
              '| è€—æ—¶ | ' + totalTime.toFixed(2) + 's â±ï¸ |\n\n' +
              (totalFailures === 0 && totalErrors === 0 && buildStatus === 'success' ? 
                'ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼' : 
                'âš ï¸ è¯·æ£€æŸ¥ä¸Šè¿°å¤±è´¥çš„æ£€æŸ¥é¡¹ã€‚\n\n> è¯¦ç»†ç»“æœè¯·æŸ¥çœ‹ä¸‹æ–¹çš„æ£€æŸ¥è¯¦æƒ…');
            
            try {
              // æ£€æŸ¥æ˜¯å¦æ˜¯ PR
              if (!context.payload.pull_request) {
                console.log('è¿™ä¸æ˜¯ä¸€ä¸ª PRï¼Œè·³è¿‡è¯„è®º');
                return;
              }
              
              // è·å–å½“å‰ bot çš„ç”¨æˆ·ä¿¡æ¯
              const { data: botUser } = await github.rest.users.getAuthenticated();
              const botLogin = botUser.login;
              
              // è·å– PR çš„æ‰€æœ‰è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              // æŸ¥æ‰¾å¹¶åˆ é™¤ä¹‹å‰çš„ CI æ£€æŸ¥ç»“æœè¯„è®º
              // é€šè¿‡è¯„è®ºå†…å®¹ï¼ˆåŒ…å« "## ğŸ“Š CI æ£€æŸ¥ç»“æœ"ï¼‰å’Œä½œè€…ï¼ˆGitHub Actions botï¼‰æ¥è¯†åˆ«
              const commentMarker = '## ğŸ“Š CI æ£€æŸ¥ç»“æœ';
              let deletedCount = 0;
              
              for (const oldComment of comments) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æˆ‘ä»¬çš„è¯„è®ºï¼šç”± bot åˆ›å»ºä¸”åŒ…å«æ ‡è®°
                if (oldComment.user.login === botLogin && oldComment.body.includes(commentMarker)) {
                  try {
                    await github.rest.issues.deleteComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: oldComment.id
                    });
                    console.log(`å·²åˆ é™¤æ—§è¯„è®º #${oldComment.id}`);
                    deletedCount++;
                  } catch (deleteError) {
                    console.log(`åˆ é™¤è¯„è®º #${oldComment.id} å¤±è´¥: ${deleteError.message}`);
                  }
                }
              }
              
              if (deletedCount > 0) {
                console.log(`å·²åˆ é™¤ ${deletedCount} æ¡æ—§è¯„è®º`);
              }
              
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              
              console.log('PR è¯„è®ºå·²æˆåŠŸåˆ›å»º');
            } catch (error) {
              console.error('åˆ›å»º PR è¯„è®ºå¤±è´¥:', error.message);
              console.error(error.stack);
              // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“æ•´ä¸ª workflow
            }
