name: CI - Pipeline before Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ========== ä»£ç è´¨é‡æ£€æŸ¥ ==========
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    # å¦‚æœå‰é¢çš„æ£€æŸ¥å¤±è´¥ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ£€æŸ¥
    continue-on-error: false
    permissions:
      contents: read  # éœ€è¦æƒé™æ¥è¯»å–ä»£ç 
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # Checkstyle ä»£ç é£æ ¼æ£€æŸ¥ï¼ˆå·²æœ‰é…ç½®æ–‡ä»¶ï¼Œå–æ¶ˆæ³¨é‡Š pom.xml ä¸­çš„æ’ä»¶å³å¯å¯ç”¨ï¼‰
      - name: Run Checkstyle
        run: mvn checkstyle:check
        continue-on-error: true  # æš‚æ—¶å…è®¸å¤±è´¥ï¼Œç­‰é…ç½®å¥½åå†æ”¹ä¸º false

      # SpotBugs é™æ€ä»£ç åˆ†æï¼ˆéœ€è¦å…ˆåœ¨ pom.xml ä¸­æ·»åŠ æ’ä»¶ï¼‰
      # - name: Run SpotBugs
      #   run: mvn spotbugs:check
      #   continue-on-error: true

  # ========== å®‰å…¨æ‰«æ ==========
#  security-scan:
#    name: Security Scan
#    runs-on: ubuntu-latest
#    continue-on-error: true  # å®‰å…¨æ‰«æå¤±è´¥ä¸åº”è¯¥é˜»æ­¢ PR
#    permissions:
#      contents: read  # éœ€è¦æƒé™æ¥è¯»å–ä»£ç 
#      security-events: write  # CodeQL éœ€è¦æƒé™æ¥ä¸Šä¼ å®‰å…¨åˆ†æç»“æœ
#      actions: read  # CodeQL éœ€è¦æƒé™æ¥è¯»å– actions
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 17
#        uses: actions/setup-java@v4
#        with:
#          distribution: temurin
#          java-version: '17'
#
#      - name: Cache Maven local repository
#        uses: actions/cache@v4
#        with:
#          path: ~/.m2/repository
#          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
#          restore-keys: |
#            ${{ runner.os }}-m2-

      # OWASP Dependency-Check - ä¾èµ–æ¼æ´æ‰«æ
      # éœ€è¦å…ˆåœ¨ pom.xml ä¸­æ·»åŠ  org.owasp:dependency-check-maven æ’ä»¶
      # - name: OWASP Dependency Check
      #   run: mvn org.owasp:dependency-check-maven:check
      #   continue-on-error: true

      # GitHub CodeQL - ä»£ç å®‰å…¨åˆ†æï¼ˆGitHub å…è´¹æä¾›ï¼‰
#      - name: Initialize CodeQL
#        uses: github/codeql-action/init@v3
#        with:
#          languages: java
#          queries: security-extended,security-and-quality
#
#      - name: Perform CodeQL Analysis
#        uses: github/codeql-action/analyze@v3
#        continue-on-error: true

  # ========== æ„å»ºå’Œæµ‹è¯• ==========
  build:
    name: Build and Unit Test
    runs-on: ubuntu-latest
    needs: []  # å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œä¸ä¾èµ–å…¶ä»– job
    permissions:
      checks: write      # éœ€è¦æƒé™æ¥åˆ›å»º check runsï¼ˆç”¨äºæµ‹è¯•ç»“æœæŠ¥å‘Šï¼‰
      pull-requests: write  # éœ€è¦æƒé™æ¥åœ¨ PR ä¸Šåˆ›å»ºè¯„è®º
      contents: read      # éœ€è¦æƒé™æ¥è¯»å–ä»£ç 
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # æ„å»ºé¡¹ç›®ï¼ˆåŒ…å«æµ‹è¯•ï¼‰
      - name: Build with Maven
        run: mvn -B -V -e -T 1C clean verify

      # ä¸Šä¼ æµ‹è¯•ç»“æœï¼ˆå¦‚æœæµ‹è¯•å¤±è´¥ï¼Œä¼šæ˜¾ç¤ºåœ¨ PR ä¸­ï¼‰
      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿä¸Šä¼ ç»“æœ
        with:
          name: Unit Test Results
          path: '**/target/surefire-reports/TEST-*.xml'
          reporter: 'java-junit'
          fail-on-error: false  # æµ‹è¯•å¤±è´¥ä¸é˜»æ­¢ workflow
          list-suites: 'all'  # æ˜¾ç¤ºæ‰€æœ‰æµ‹è¯•å¥—ä»¶
          list-tests: 'failed'  # åªåˆ—å‡ºå¤±è´¥çš„æµ‹è¯•
          max-annotations: 50  # æœ€å¤§æ³¨é‡Šæ•°é‡

      # ä»£ç è¦†ç›–ç‡æŠ¥å‘Šï¼ˆéœ€è¦å…ˆåœ¨ pom.xml ä¸­æ·»åŠ  JaCoCo æ’ä»¶ï¼‰
      # - name: Generate Coverage Report
      #   run: mvn jacoco:report
      #   continue-on-error: true

      # - name: Upload Coverage to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     files: '**/target/site/jacoco/jacoco.xml'
      #     fail_ci_if_error: false


  # ========== ä»£ç æ ¼å¼åŒ–æ£€æŸ¥ ==========
#  format-check:
#    name: Code Format Check
#    runs-on: ubuntu-latest
#    continue-on-error: true
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 17
#        uses: actions/setup-java@v4
#        with:
#          distribution: temurin
#          java-version: '17'

      # æ£€æŸ¥ä»£ç æ˜¯å¦ç¬¦åˆ Google Java Formatï¼ˆéœ€è¦å…ˆé…ç½®æ ¼å¼åŒ–æ’ä»¶ï¼‰
      # - name: Check Code Format
      #   run: mvn com.spotify.fmt:fmt-maven-plugin:check
      #   continue-on-error: true

  # ========== PR æ³¨é‡Šæ€»ç»“ï¼ˆå¯é€‰ï¼‰ ==========
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [build, code-quality]
    if: always()
    permissions:
      issues: write      # éœ€è¦æƒé™æ¥åˆ›å»º/æ›´æ–° issue è¯„è®ºï¼ˆPR ä¹Ÿæ˜¯ issueï¼‰
      pull-requests: write  # éœ€è¦æƒé™æ¥åœ¨ PR ä¸Šæ“ä½œ
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // è·å–å„ä¸ª job çš„çŠ¶æ€
            const buildStatus = '${{ needs.build.result }}';
            const qualityStatus = '${{ needs.code-quality.result }}';
            
            // çŠ¶æ€å›¾æ ‡æ˜ å°„
            const getStatusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'cancelled') return 'ğŸš«';
              if (status === 'skipped') return 'â­ï¸';
              return 'â³';
            };
            
            const summary = `## CI æ£€æŸ¥ç»“æœ
            
            | æ£€æŸ¥é¡¹ | çŠ¶æ€ |
            |--------|------|
            | æ„å»ºå’Œæµ‹è¯• | ${getStatusIcon(buildStatus)} ${buildStatus} |
            | ä»£ç è´¨é‡ | ${getStatusIcon(qualityStatus)} ${qualityStatus} |
            
            > è¯¦ç»†ç»“æœè¯·æŸ¥çœ‹ä¸‹æ–¹çš„æ£€æŸ¥è¯¦æƒ…
            `;
            
            try {
              // æ£€æŸ¥æ˜¯å¦æ˜¯ PR
              if (!context.payload.pull_request) {
                console.log('è¿™ä¸æ˜¯ä¸€ä¸ª PRï¼Œè·³è¿‡è¯„è®º');
                return;
              }
              
              // åˆ›å»ºè¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
              
              console.log('PR è¯„è®ºå·²æˆåŠŸåˆ›å»º');
            } catch (error) {
              console.error('åˆ›å»º PR è¯„è®ºå¤±è´¥:', error.message);
              // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“æ•´ä¸ª workflow
            }
